基于深度森林的网络匿名流量检测方法研究与应用
李成豪，***，***
（南京理工大学，江苏 南京 450001）
摘  要：随着互联网技术的飞速发展，网络已成为人类生活不可或缺的活动空间。网络服务和应用层出不穷，致使网络流量数据规模迅速增大。因此，如何快速准确地识别流量类型和过滤某些恶意流量变得至关重要。流量分类成为许多研究工作的主题，但是互联网服务的快速发展和加密技术的普及使得它成为一个开放的挑战。加密对于保护互联网用户的隐私至关重要，这是近年来出现的各种隐私增强工具中使用的一项关键技术。Tor是其中最流行的一种匿名流量通信工具，它通过加密发送方和接收方之间的通信量，并通过分布式服务器网络路由来实现发送方和接收方的解耦。Tor匿名通信网络的发展为犯罪分子提供了隐匿空间，给网络监管带来了十分严峻的挑战。在本文中，针对Tor匿名通信系统在原有深度森林的不足设计了一种基于改进深度森林模型用于Tor匿名网络流量行的识别。实验结果表明，与已有识别方法相比，提出的识别模型在准确率、时间、内存等方面有着明显的提升。
关键词：恶意流量；流量分类；Tor；深度森林；
Research and application of network anonymous traffic detection method based on deep forest
***, ***, ***
People’s Liberation Army Strategic Support Force Information Engineering University, Zhengzhou 450001, China
Abstract: With the rapid development of Internet technology, the network has become an indispensable activity space for human life. Network services and applications emerge one after another, resulting in the rapid increase of the scale of network traffic data. Therefore, how to quickly and accurately identify traffic types and filter some malicious traffic becomes very important. Traffic classification has become the subject of many research work, but the rapid development of Internet services and the popularity of encryption technology make it an open challenge. Encryption is very important to protect the privacy of Internet users, which is a key technology used in various privacy enhancement tools in recent years. Tor is one of the most popular anonymous traffic communication tools. It encrypts the traffic between the sender and the receiver, and decouples the sender and the receiver through the distributed server network routing. Although the deep learning based on neural network model has achieved great success in classification, successful models often need a large number of data sets to train, have too many super parameters, and the learning performance is too dependent on the adjustment of super parameters. As a new deep learning model based on decision tree, deep forest model can build deep model without back propagation training and achieve remarkable results, but the high memory demand and high time overhead inhibit the training of large model. In this paper, aiming at the deficiency of deep forest, an anonymous network traffic behavior detection and application recognition method based on improved deep forest is designed to detect tor traffic.
Key words: network slicing, isolation, performance degradation, side channel attack

 
1  引言
随着互联网的飞速发展，互联网的规模在不断的扩大。互联网逐渐渗透到社会、经济、政治的方方面面，互联网中人们的安全和隐私保护问题日益严峻。匿名网络设计的初衷虽然是为了保护用户的隐私，但往往被不法分子滥用，以逃避网络追踪，进而实施恶意网络活动。由于匿名通信网络使用加密、多节点转发和填充等多种流量混淆方法隐藏了原始流量的特点，这使得传统流量识别技术已经无法准确识别匿名流量。个人用户、企业和政府每天都会使用各种网络应用，每天都会产生数以亿计的网络流，恶意流量很容易将自己隐藏在海量的流量中，进而发动攻击，给网络安全带来极大的威胁。所以研究如何准确高效的识别海量流量中具有恶意的网络行为，对于网络安全发展具有极其重要的科学研究意义。
Tor作为目前使用最广泛的匿名通信系统之一。它在2004年推出了一项称为隐藏服务的技术，它实现了客户端与服务端的双端匿名。通过使用隐藏服务技术，任何服务运营商都可以在提供网络服务的同时隐藏其服务器的物理地址。所以Tor拥有的用户最多，分布范围最广，平均每天的用户数量已经超过350万人。朴茨茅斯大学的Owen Gareth等研究人员在为期六个月的研究中观察到80%以上针对隐藏服务的访问请求都指向己知的著名虐童网站。此外，枪支与毒品交易也是暗网市场不可或缺的部分。因此Tor检测一直是学术界研究的主题之一，但其中许多研究侧重于降低Tor的匿名性或提高其性能。对Tor流量的分析与识别的研究少之又少。因此对Tor匿名网络流量进行分析与识别具有很强的代表性。
Tor采用了TLS加密技术，检测者无法提取Tor流量内部的有效载荷特征，加密网络流量给网络安全防御带来了巨大的挑战，在不加解密的基础上识别Tor匿名流量具有十分重要的研究意义。Tor 虽然通过加密和封装等方式将非正常流量隐藏于普通流量，但是仍然可以基于Tor网络流特征的微小差异对其进行识别。随着机器学习的快速发展，越来越多的研究人员将机器学习技术应用于对Tor匿名流量的识别中，并取得了一定的研究成果，但也存在模型复杂度高、训练时间长、需要庞大的训练数据集作支撑、模型泛化能力差等方面缺陷。本文根据Tor工作特点采取时间相关特征对其进行描述。并提出了基于深度森林的Tor匿名流量检测可以在少量的数据集以及较短的时间和内存消耗取得较高的准确率。
2  相关工作
目前为止，国内外学者从不同角度对网络流量分类方法进行了研究。早期通过Tor通信的端口号、IP通信地址等。基于端口识别的分类方法在早期可以通过检查分组的传输层端口号，然后根据IANA定制的知名端口号与注册端口号列表将分组与应用对应起来。随着网络应用的不断更新发展Tor流量也对其数据包进行了加密处理无法检测其端口号，进而导致基于端口的流量分类方法已不再适用。目前根据原理和方法
将混淆流量分为深度包检测技术和基于机器学习的流量识别技术。
深度包检测技术（Deep Packet Inspection, DPI）的方法出现在上个世纪90年代。这种方法不仅仅检测包的端口，同时也对包头和包的数据进行检测。基于深度包检测的方法优势主要有两个，一是非常高的准确率，二是可以在早期就检测出异常行为。但是基于深度包检测的方法存在着计算复杂度高、无法处理加密信息、指纹获取困难、无法检测位置网络数据等缺点。
随着人工智能的不断发展，机器学习广泛应用于流量识别与分类任务并得了良好的成果。机器学习方法和入侵检测系统相结合，充分发挥机器学习方法强大的数据学习能力和判别能力，为网络特征流量检测增添了新的技术手段。机器学习方法应用在网络特征流量检测系统的核心思想是：根据网络流量信息（网络服务类型、IP地址、协议类型、连接状态等）和主机信息（文件访问权限、没干资源访问、应用程序进程等）来建立相应的机器学习模型，进而对正常的流量和异常流量进行分类。
深度学习最大的贡献是表征学习，即通过端到端的训练，发现更好的特征。表征学习的目的是自动学习有用的数据特征，对复杂的原始数据化繁为简，把原始数据的无效信息剔除，把有效信息更有效地进行提炼。深度森林是一种基于决策树的集成学习方法，有着很强的表征学习能力。深度森林包含级联森林和多粒度扫描两个主要组件。级联结构使得深度森林可以进行表征学习。在级联森林中，每层都是由多个决策树森林的集成组成，也就是说，每层都是一个集成的集成。级联的每层接收上一层处理得到的输出信息作为其增广的输入信息。对于特征之间存在关系信息的数据，深度森林通过一种称为多粒度扫描的技术进一步增强其表示学习的能力。深度森林不需要像深度学习，需要复杂的超参数和庞大的数据集依然可以得到很高准确率。但是深度森林由于所有的样本都需要通过深度森林的所有层级，这就导致时间复杂度随层数线性变化。其次滑动窗口使每一个样本产生成百上千个新样本，造成了巨大的计算开销。为了解决深度森林存在的问题，本文在深度森林的基本框架中引入了置信筛分机制用以降低深度森林的内存需求和时间开销。
通过阅读大量文献我们可以发现许多论文研究Tor匿名通信系统都是使用从流中提取的特征，很少有论文专门关注基于时间的特征。只有Arash Habibi等人提出了一组基于时间的特征来识别和刻画Tor流量，并证明了只有使用基于时间的特征才能在一定程度上识别和刻画Tor流量。本文采用了基于时间特征的UNB-CIC Tor 数据集。采取基于时间特征的数据集通过改进深度森林算法取得了同深度森林相同甚至更好好的准确率，同时大大缩小了训练时间和内存。
3  Tor匿名通信系统
3.1.1匿名通信系统
匿名通信是指通过多层加密、代理中继、流量混淆等技术手段来隐藏通信内容、隐蔽通信关系的隐私保护技术。为了确保匿名效果，匿名通信系统通常会借助多跳的代理节点通过多层加密来构建数据链路，这些链路和节点共同构成了匿名通信系统。匿名通信系统的核心功能在于通过多跳反向代理或分布式共享存储来隐藏服务提供商的真实网络地址，从而保证匿名服务不可被追源。
3.2 Tor匿名通信系统及其接入技术
Tor 匿名通信系统即第二代洋葱路由系统作为目前使用最广泛的匿名通信系统之一，其核心技术“洋葱路由”由美国海军研究实验室提出。Tor 暗网的基本组件包括客户端（Alice）、隐藏服务器（Bob）、洋葱路由节点、目录服务器和隐藏服务目录服务器。为了构建 Tor 匿名通信线路，Tor 代理程序首先必须从目录服务器中获取当前网络状态以及可用洋葱路由的列表；然后从洋葱路由列表中选择至少三个洋葱路由节点作为中转节点，洋葱路由节点主要负责匿名通信链路的建立以及数据的转发，每个洋葱路由之间都通过 TLS 进行连接。入口节点与客户端连接，出口节点与服务器连接。
匿名接入技术是匿名通信网络为应对网络监管而提出的客户端隐蔽接入技术。监管者出于安全审查的目的，会检测或屏蔽用户对匿名网络中继节点的连接。为了规避此类网络审查，匿名通信技术研究人员提出了多种接入技术，在 Tor 匿名通信网络中，较为常见的接入技术包括br
idge、OBFS、meek以及FTE等。
3.3 Tor网络流量分析
匿名通信技术的起源是用于对用户私密信息的保护，但匿名通信系统同时也是一把双刃剑。Tor匿名通信系统作为匿名通信系统使用最为广泛的通信系统之一，已经逐渐变成违法犯罪分子用来构建开展禁品交易、有害信息传播的法外之地。有效对其准确识别具有十分重大的意义。
Tor采用了加密技术，致使检测者无法直接识别其中内容，但目前版本的Tor匿名通信系统无法隐藏流量中应用的特征。不同应用类型传输的用户数据类型、大小和传输速率存在较大的差
异性，而同一类的不同应用程序之间往往会具有相似的通信活动行为。
使用者通过Tor客户端发送一个请求，默认至少需要通过三个洋葱路由节点的转发才能够到达目标服务器，而且这三个洋葱路由节点通常部署在不同国家的不同地区，因此Tor网络流量的转发时延相对正常流量通常会大很多，本文针对Tor流持续时间、双向包到达时间间隔等特征来描述转发时延差异，进而对Tor流量进行识别。
4  网络匿名流量检测模型设计
4.1深度森林简介
深度森林是一种新颖的决策树集成学习方法，具有很高的预测精度。深度森林模型包含两个核心组件，即级联森林结构和多粒度扫描。级联结构是的深度森林可以进行表征学习。级联森林的每层由多个随机森林分类器和完全随机森林分类器组成，也就是说每层都是一个集成的集成。每层通过接受上层的结果来对其输入信息进行扩展。多粒度扫描使用滑动窗口扫描原始特征，并通过使用多个尺寸的滑动窗口，获得更多的变换的特征向量，进而增强级联森林，这使得深度森林模型在处理时序特征数据或空间特征数据的效果表现的十分好。
4.2 改进深度森林模型设计
尽管Zhou等人的实验结果表明进一步增大深度森林的模型将得到更好的准确率。但如果在多粒度扫描中使用更多不同的滑动窗口产生多更的变换的特征向量，级联森林的每层随机森林中使用更多的决策树，与此同时深度森林模型的训练和预测将需要更高的内存需求和时间开销。导致这种问题的主要原因有两方面。首先所有的样本都要经过级联森林的每一层，导致时间复杂度随着层数的增加而线性增加。其次在多粒度扫描中，使得每一个原始样本都会产生成百上千个变换的新样本，大幅度增加了训练样本，造成了巨大的计算开销。
4.2.1 改进的级联森林
为解决所有样本都要经过级联森林的每一层而带来的时间和空间的开销，本文在级联森林结构引入了置信机制。具体来说置信筛分是将级联的每一层的实例分为两个子集：一个是容易预测的；另一个是难以预测的。如果一个实例很容易预测就直接当成最终结果输出，只有当一个实例很难预测时，它才需要被传递到下一层。如图3.1改进深度森林模型所示。 
 
改进深度森林的级联结构如上图所示。基于置信机制的深度森林与原始深度森林主要得不同点两个方面。首先改进的深度森林在级联的每一层都有门结构，将样本集划分为容易预测的样本和难以预测的样本两个子集。如图所示具有高预测置信度的样本（Y）将直接输入到最后不需要经历到后续的所有层；只有低预测置信度的样本（N）被传递到下一层。其次，由于后续随之样本数量的不断减少，剩余样本的预测难度也越来越大。基于置信机制的深度森林将逐层增加每个森林中决策树的数量用来增大森林模型复杂度来训练剩余的样本，而原始深度森林模型每层使用相同复杂度的深度森林模型。实验结果证明，随着层数的增加，从低到高增加级联中森林的复杂度可以使得模型具有更好的泛化误差上届。
对于一个三分类问题，一个样本的预测类别分布向量为[0.7,0.2,0.1]，则该样本的预测置信度为0.7。如图3.2所示。
 
如何设置级联每一层的置信度阈值是一个关键的问题。本文使用的是一种简单的阈值设置准则，自动化的确定每一层所需要的置信度阈值，从而在保证深度森林的预测性能的同时，大幅度提升其计算效率。在级联的第t层，预测置信度阈值n_t基于当前层级的交叉验证错误率ϵ_t自动确定。令超参数α<1表示高置信度样本所需要达到的交叉验证错误率αϵ_t。将所有的训练样本按照它们的预测置信度降序排序，其中c_i表示样本x_i的预测置信度。置信度阈值的设置方式如下：
n_t=min{c_k│L(x_1,…,x_k )<αϵ_t,k∈[1,m] },（3.1）
其中L(x_1,…,x_k )=1/k ∑_(i=1)^k▒1[g_t (x_i)≠y_i ] 表示预测置信度最高的k个样本的交叉验证错误率。
4.2.2 改进的多粒度扫描
深度森林中的多粒度扫描过程会使得训练模型的内存和时间开销大大增加。为了解决这一问题，改进的多粒度扫描，本文采取采样多粒度扫描方法。在采样多粒度扫描中，首先通过滑动窗口生成新的样本，再从新的样本中随机采集一个子集用于后续的森林模型的训练。本文只考虑二分类问题如图3.3所示，随机采样不仅能够大幅度降低新样本的树木，还能够将多粒度扫描过程中所生成的转换特征的维度大幅度降低。——从903维降低到90维。随着级联森林层数的增加， 
 
置信筛分将更难预测的样本保留下来，为此在每一层都新增采样多粒度扫描产生的转换特征增强其表示。
基于置信机制的深度森林主要包含三个部分：置信筛分机制、可变模型复杂度机制和采样多粒度扫描。如果原始输入为400维属性特征，大小为100维的滑动窗口被用于采样多粒度扫描，采样规模为30。对于n个训练样本，该滑动窗口将产生包含30 ×n个新的训练样本，每个样本有100维的新的训练集。使用改训练集得到两个不同类型的森林（随机森林和完全随机森林）。对于一个三分类问题，两个森林模型会产生180维的转换特征。该转换特征被用于后续级联森林的输入。直至达到预设的终止条件。
联森林的每层将Tor流量数据集划分为两个子集。只将难以预测的样本子集传入下个层级，并随着样本的减少，增大森林的复杂度。给定一个测试样本，其特征表示随着层数的增加不断扩增。如果该样本的预测置信度超出了当前层级的置信度阈值，则根据当前层级的输出结果作为该样本的最终预测。如果该样本的预测置信度低于当前层级的置信度阈值，则将该样本传递到下一层。在最坏情况下，该测试样本将遍历所有的层级在最终层获得其预测结果。预测结果为输出的类别分布向量中的最大类别。
5  实验
5.1 UNB-CIC Tor 数据集简介与处理
为了评估提出方法的有效性，本文使用了UNB（University of New Brunswick）发布的Tor流量有标签数据集来验证本文所提出的方法。研究人员首先在物理计算机中组成两个虚拟机：网关和工作站，如图4.1所示。由于所有Tor流量必须通过网关才能到达工作站，因此Tor流量变得透明。Tor流量数据包在网关处捕获，非Tor流量在通过网关的工作站处捕获。研究人员使用Wireshark 和 tcpdump 工具捕获流量，总共生成了22 GB的PCAP文件。
本文使用ISCXFlowMeter 应用程序来解析pcap数据包。按照具有相同<目的 IP，目的端口，源 IP，源端口，协议> 值的数据包定义为流。FlowMeter 生成双向流，以第一个数据包确定正向（从源到目的地）和反向（从目的地到源）方向，因此统计时间相关的特征也在正向和反向分别计算。请注意，TCP 流通常在连接断开时终止（由 FIN 数据包），而 UDP 流则由流超时终止。流超时值可以由单独的方案任意分配。
 

 
流超时值	Tor	nonTor	总计
10s	8044	59790	67834
15s	5631	48123	53754
30s	3130	43892	47022
60s	1723	41376	43099
120s	969	38285	39254
 
 
本文需要从混合流量中检测出Tor流量，因此对数据集划分为Tor流量和非Tor流量。在本文中研究了几个流超时值，以确定流超时对最终结果的影响。特别是，我们将流的持续时间设置为10、15、30、60和120秒。表5.1显示了在不同流超时值下，对Tor流量行为检测提取的数据分布。
本文共提取了23个特征属性作为模型的输入，其中 mean、max、min、std分别表示均值、最大值、最小值和标准差。如表5.2UNB-CIC Tor 数据集提取的特征属性及其描述所示。可以看到，除了显流的持续时间之外，还有六组特征。前三

 

特征属性	描述
Fiat mean/max/min/std	正向流中包到达间隔的 mean/max/min/std
Biat mean/max/min/std	反向流中包到达间隔的 mean/max/min/std
Flowiat mean/max/min/std	包到达间隔时间的 mean/max/min/std
Active mean/max/min/std	流变为空闲态之前活动时间的 mean/max/min/std
Idle mean/max/min/std	流变为活动态之前空闲时间的 mean/max/min/std
Fb_psec	每秒流字节数
Fp_psec	每秒流数据包数
Duration	流持续时间
组分别是-fiat、-biat和-flowiat，分别关注正向、反向和双向流。第四组和第五组特征是针对空闲到活跃或活跃到空闲状态计算的。最后一组特征重点关注每秒数据包的大小和数量。
5.2实验设置
为了验证本文算法的可行性，本文在表5.3所示的实验环境下进行实验。
类别	参数
处理器	Intel(R) Core(TM) i5-6300 CPU 
显卡	NVIDIA GeForce GTX 960M
Python3	3.7
Tensorflow	2.8.0
          Scikit-learn 	 1.0.2
参数设置：在级联森林中每个层级包含4个随机森林和4个完全随机森林；每个森林通过3折交叉验证生成样本的类别分布向量。
5.3

